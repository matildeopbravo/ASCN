---

- name: Create MySQL PVC
  kubernetes.core.k8s:
    state: present
    src: kubernetes/mysql/mysql-pvc.yml
    namespace: default

- name: Create MySQL deployment
  kubernetes.core.k8s:
    state: present
    src: kubernetes/mysql/mysql-deployment.yml
    namespace: default

- name: Create MySQL service
  kubernetes.core.k8s:
    state: present
    src: kubernetes/mysql/mysql-service.yml
    namespace: default

- name: Get mysql pod name
  kubernetes.core.k8s_info:
    kind: Pod
    wait: true
    wait_condition:
      type: Ready
    label_selectors:
      - app = mysql
  register: mysql_pod

- name: Create Ghost deployment
  kubernetes.core.k8s:
    state: present
    src: kubernetes/ghost/ghost-deployment.yml
    namespace: default

- name: Create Ghost service
  kubernetes.core.k8s:
    state: present
    src: kubernetes/ghost/ghost-service.yml
    namespace: default
  register: ghost_service

- name: Wait for Ghost
  kubernetes.core.k8s_info:
    kind: Pod
    wait: true
    wait_condition:
      type: Ready
    label_selectors:
      - app = ghost

- name: Sleep 30s (wait for migrations to run)
  command: sleep 30

- name: Create admin account
  command: kubectl exec "{{ mysql_pod.resources[0].metadata.name }}" -- mysql --host=localhost --database=ghost --password=ghost --user=ghost --execute="update users set name='ascn', email='ascn@example.com', status='active', password='$2a$10$l/W1iz.xP5j21iVob31aZOf4r7shBdjtROqNLlDiTSHVD6wUSRc4i' where id=1;"

- name: Set ghost_ip
  set_fact:
    ghost_ip: "{{ghost_service.result.status.loadBalancer.ingress[0].ip}}"
    ghost_port: "{{ ghost_service.result.spec.ports[0].port }}"
